import { Router, Request, Response } from 'express';
import {
  verifyAuth,
  verifyCreatorAccess,
  requirePermissions,
} from '../middleware/auth';
import * as aiService from '../services/ai';
import * as personaAgent from '../services/persona-agent';
import * as personaAgentOpenAI from '../services/persona-agent-openai';

const router = Router();

// POST /ai/chat - Generate AI response for product chat
router.post(
  '/chat',
  verifyAuth,
  requirePermissions('canManageProducts'),
  async (req: Request, res: Response) => {
    try {
      const { message, productContext, conversationHistory } = req.body;

      if (!message) {
        res.status(400).json({ error: 'Message is required' });
        return;
      }

      const response = await aiService.generateProductChatResponse(
        message,
        productContext || {},
        conversationHistory || []
      );

      res.json({ response });
    } catch (error) {
      console.error('Error generating chat response:', error);
      res.status(500).json({ error: 'Failed to generate response' });
    }
  }
);

// POST /ai/objections - Generate objection responses
router.post(
  '/objections',
  verifyAuth,
  requirePermissions('canManageProducts'),
  async (req: Request, res: Response) => {
    try {
      const { productContext, objections } = req.body;

      if (!objections || !Array.isArray(objections) || objections.length === 0) {
        res.status(400).json({ error: 'Objections array is required' });
        return;
      }

      const responses = await aiService.generateObjectionResponses(
        productContext || {},
        objections
      );

      res.json({ responses });
    } catch (error) {
      console.error('Error generating objection responses:', error);
      res.status(500).json({ error: 'Failed to generate objection responses' });
    }
  }
);

// POST /ai/preview - Generate WhatsApp preview messages
router.post(
  '/preview',
  verifyAuth,
  requirePermissions('canManageProducts'),
  async (req: Request, res: Response) => {
    try {
      const { productContext } = req.body;

      const messages = await aiService.generateWhatsAppPreview(productContext || {});

      res.json({ messages });
    } catch (error) {
      console.error('Error generating preview:', error);
      res.status(500).json({ error: 'Failed to generate preview' });
    }
  }
);

// POST /ai/analyze - Analyze uploaded file
router.post(
  '/analyze',
  verifyAuth,
  requirePermissions('canManageProducts'),
  async (req: Request, res: Response) => {
    try {
      const { fileUrl, fileType } = req.body;

      if (!fileUrl || !fileType) {
        res.status(400).json({ error: 'File URL and type are required' });
        return;
      }

      const analysis = await aiService.analyzeProductFile(fileUrl, fileType);

      res.json(analysis);
    } catch (error) {
      console.error('Error analyzing file:', error);
      res.status(500).json({ error: 'Failed to analyze file' });
    }
  }
);

// POST /ai/analyze-file - Analyze uploaded file and return structured analysis
// Supports two modes:
// 1. fileUrl only: Downloads file from URL then analyzes (slower)
// 2. fileContent (base64): Analyzes directly without download (faster, for parallel processing)
router.post(
  '/analyze-file',
  verifyAuth,
  requirePermissions('canManageProducts'),
  async (req: Request, res: Response) => {
    try {
      const { fileUrl, fileName, fileType, fileContent } = req.body;

      // Either fileUrl or fileContent is required
      if (!fileUrl && !fileContent) {
        res.status(400).json({ error: 'Either fileUrl or fileContent is required' });
        return;
      }

      const analysis = await aiService.analyzeAndSummarizeFile(
        fileUrl || '',
        fileName || '',
        fileType || 'application/pdf',
        fileContent // base64 content for faster processing
      );

      // Return the full structured analysis object
      // Contains: suggestedName, suggestedDescription, suggestedBenefits, suggestedPrice, topics, targetAudience, summary
      res.json(analysis);
    } catch (error) {
      console.error('Error analyzing file:', error);
      res.status(500).json({ error: 'Failed to analyze file' });
    }
  }
);

// POST /ai/conversation/save - Save product conversation
router.post(
  '/conversation/save',
  verifyAuth,
  verifyCreatorAccess,
  requirePermissions('canManageProducts'),
  async (req: Request, res: Response) => {
    try {
      const { creatorId, productId, messages, productContext } = req.body;

      if (!creatorId || !productId) {
        res.status(400).json({ error: 'Creator ID and Product ID are required' });
        return;
      }

      await aiService.saveProductConversation(
        creatorId,
        productId,
        messages || [],
        productContext || {}
      );

      res.json({ success: true });
    } catch (error) {
      console.error('Error saving conversation:', error);
      res.status(500).json({ error: 'Failed to save conversation' });
    }
  }
);

// POST /ai/extract-value - Extract clean value from conversational text
router.post(
  '/extract-value',
  verifyAuth,
  requirePermissions('canManageProducts'),
  async (req: Request, res: Response) => {
    try {
      const { rawInput, fieldType, context } = req.body;

      if (!rawInput || !fieldType) {
        res.status(400).json({ error: 'rawInput and fieldType are required' });
        return;
      }

      const result = await aiService.extractCleanValue(rawInput, fieldType, context);
      res.json(result);
    } catch (error) {
      console.error('Error extracting value:', error);
      res.status(500).json({ error: 'Failed to extract value' });
    }
  }
);

// POST /ai/creator-welcome - Generate welcome message for creator profile
router.post(
  '/creator-welcome',
  verifyAuth,
  async (req: Request, res: Response) => {
    try {
      const { creatorData } = req.body;

      if (!creatorData || !creatorData.displayName) {
        res.status(400).json({ error: 'creatorData with displayName is required' });
        return;
      }

      const welcomeMessage = await aiService.generateCreatorWelcomeMessage(creatorData);
      res.json({ welcomeMessage });
    } catch (error) {
      console.error('Error generating welcome message:', error);
      res.status(500).json({ error: 'Failed to generate welcome message' });
    }
  }
);

// ============================================================================
// PERSONA AGENT ENDPOINTS (Claude-based conversational onboarding)
// ============================================================================

// POST /ai/persona/init - Initialize persona agent conversation
router.post(
  '/persona/init',
  verifyAuth,
  async (req: Request, res: Response) => {
    try {
      const result = await personaAgent.initializePersonaConversation();
      res.json(result);
    } catch (error) {
      console.error('Error initializing persona conversation:', error);
      res.status(500).json({ error: 'Failed to initialize conversation' });
    }
  }
);

// POST /ai/persona/chat - Send message to persona agent
router.post(
  '/persona/chat',
  verifyAuth,
  async (req: Request, res: Response) => {
    try {
      const { message, conversationHistory, currentPersonaData, provider } = req.body;

      if (!message) {
        res.status(400).json({ error: 'Message is required' });
        return;
      }

      // Support switching between Claude and OpenAI
      let result;
      if (provider === 'openai') {
        result = await personaAgentOpenAI.runPersonaAgentOpenAI(
          message,
          conversationHistory || [],
          currentPersonaData || {}
        );
      } else {
        // Default to Claude (Anthropic)
        result = await personaAgent.runPersonaAgent(
          message,
          conversationHistory || [],
          currentPersonaData || {}
        );
      }

      res.json(result);
    } catch (error) {
      console.error('Error in persona agent chat:', error);
      res.status(500).json({ error: 'Failed to process message' });
    }
  }
);

// ============================================================================
// OPENAI PERSONA AGENT ENDPOINTS (Alternative to Claude)
// ============================================================================

// POST /ai/persona/openai/init - Initialize OpenAI persona agent conversation
router.post(
  '/persona/openai/init',
  verifyAuth,
  async (req: Request, res: Response) => {
    try {
      const result = await personaAgentOpenAI.initializePersonaConversationOpenAI();
      res.json(result);
    } catch (error) {
      console.error('Error initializing OpenAI persona conversation:', error);
      res.status(500).json({ error: 'Failed to initialize conversation' });
    }
  }
);

// POST /ai/persona/openai/chat - Send message to OpenAI persona agent
router.post(
  '/persona/openai/chat',
  verifyAuth,
  async (req: Request, res: Response) => {
    try {
      const { message, conversationHistory, currentPersonaData } = req.body;

      if (!message) {
        res.status(400).json({ error: 'Message is required' });
        return;
      }

      const result = await personaAgentOpenAI.runPersonaAgentOpenAI(
        message,
        conversationHistory || [],
        currentPersonaData || {}
      );

      res.json(result);
    } catch (error) {
      console.error('Error in OpenAI persona agent chat:', error);
      res.status(500).json({ error: 'Failed to process message' });
    }
  }
);

export default router;
